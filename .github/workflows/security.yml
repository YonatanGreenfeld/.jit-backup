name: Workflows generated by the MVS plan
on:
  workflow_dispatch:
    inputs:
       client_payload:
          description: The Client payload
          required: true
jobs:
  Scan-code-for-vulnerabilities-go:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '62fadf4d-41c0-44f0-9741-d59cadf2eac1') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-for-vulnerabilities-go'
    runs-on: ubuntu-latest
    steps:
    - name: golang-code-scanning
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-gosec-alpine:latest
        security_control_args: -fmt=json -severity=high /code/...
        
        dispatch_type: workflow

  Scan-code-for-vulnerabilities-python:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, 'a743023f-4803-4b2f-a4a6-b6daa11041a2') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-for-vulnerabilities-python'
    runs-on: ubuntu-latest
    steps:
    - name: python-code-scanning
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-bandit-slim:latest
        security_control_args: -r /code -f json -q -ll -iii
        security_control_output_file: /tmp/report.json
        dispatch_type: workflow

  Scan-code-for-vulnerabilities-JS:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '4c2c3bec-7e60-4167-baf0-5c5986124652') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-for-vulnerabilities-JS'
    runs-on: ubuntu-latest
    steps:
    - name: semgrep-code-scanning
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-semgrep-alpine:main
        security_control_args: --json --config=/semgrep-config.yml --metrics=off --severity=ERROR /code
        
        dispatch_type: workflow

  Scan-code-dependencies-for-vulnerabilities-NodeJS:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '49cd95da-9035-4f76-8cb1-6a489e630830') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-dependencies-for-vulnerabilities-NodeJS'
    runs-on: ubuntu-latest
    steps:
    - name: dependency-check-node
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-npm-audit-slim:latest
        security_control_args: audit --json --production
        
        dispatch_type: workflow

  Scan-code-dependencies-for-vulnerabilities-go_deps:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '300fa37f-8826-49dc-8e97-949a8e51f2b2') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-dependencies-for-vulnerabilities-go_deps'
    runs-on: ubuntu-latest
    steps:
    - name: nancy
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-nancy-alpine:latest
        security_control_args: 
        security_control_output_file: output.json
        dispatch_type: workflow

  Scan-code-dependencies-for-vulnerabilities-python:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, 'fb51b02f-83a8-4b6c-ac0e-2bd2c9e9d263') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'Scan-code-dependencies-for-vulnerabilities-python'
    runs-on: ubuntu-latest
    steps:
    - name: dependency-check-python
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-dependency-check-alpine:latest
        security_control_args: --scan /code --enableExperimental --disableJar --disableRubygems --disableBundleAudit --disableCocoapodsAnalyzer --disableSwiftPackageManagerAnalyzer --disableSwiftPackageResolvedAnalyzer --disableAutoconf --disableCmake --disableComposer --disableCpan --disableNuspec --disableNugetconf --disableAssembly --disableGolangDep --disableGolangMod --disableNodeJS --disableYarnAudit --disableNodeAudit --format JSON --noupdate --out /tmp/report.json --log /code/error.txt
        security_control_output_file: /tmp/report.json
        dispatch_type: workflow

  secret-detection-any:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '13d7949c-3792-4145-86d2-239f0ddc6b1b') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'secret-detection-any'
    runs-on: ubuntu-latest
    steps:
    - name: secrets-detection
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-gitleaks-alpine:latest
        security_control_args: detect --config /config/gitleaks.toml --source /code -v  --report-format json --report-path /tmp/report.json --redact --no-git
        security_control_output_file: /tmp/report.json
        dispatch_type: workflow

  secret-detection-any:
    if: contains( fromJSON(github.event.inputs.client_payload).payload.control_ids, '960a945f-7c9b-4f91-97d5-41eb0df35ae4') || fromJSON(github.event.inputs.client_payload).payload.workflow_job_name == 'secret-detection-any'
    runs-on: ubuntu-latest
    steps:
    - name: secrets-detection
      uses: jitsecurity-controls/jit-github-action@v1.5
      with:
        docker_user: jit-bot
        docker_password: Z2hwX1JrdUpqZk5QTk5XWmpzVDRZb0J0Z3ZCNnBJOGtNMDNBbDlzMAo=
        security_control: ghcr.io/jitsecurity-controls/control-gitleaks-alpine:latest
        security_control_args: detect --config /config/gitleaks.toml --source /code -v  --report-format json --report-path /tmp/report.json --redact --log-opts "-1"
        security_control_output_file: /tmp/report.json
        dispatch_type: workflow
